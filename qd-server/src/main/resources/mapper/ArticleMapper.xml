<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.qd.mapper.ArticleMapper">


    <select id="pageQuery" resultType="com.qd.vo.ArticleVO">
        SELECT
        a.id                AS id,
        a.title             AS title,
        a.slug              AS slug,
        a.summary           AS summary,
        a.cover_url         AS coverUrl,
        a.main_category_name AS mainCategory,
        a.view_count        AS viewCount,
        a.like_count        AS likeCount,
        a.published_at      AS publishedAt
        FROM article a
        <where>
            a.status = 1
            AND a.published_at IS NOT NULL
            <if test="keyword != null and keyword != ''">
                AND (a.title LIKE CONCAT('%', #{keyword}, '%')
                OR  a.summary LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="categoryId != null">
                AND (
                a.main_category_id = #{categoryId}
                OR EXISTS (
                SELECT 1 FROM article_category ac
                WHERE ac.article_id = a.id AND ac.category_id = #{categoryId}
                )
                )
            </if>
            <if test="tagId != null">
                AND EXISTS (
                SELECT 1 FROM article_tag at2
                WHERE at2.article_id = a.id AND at2.tag_id = #{tagId}
                )
            </if>
        </where>
        <choose>
            <when test="'hot'.equals(sort)">
                ORDER BY a.view_count DESC, a.like_count DESC, a.id DESC
            </when>
            <otherwise>
                ORDER BY a.published_at DESC, a.id DESC
            </otherwise>
        </choose>
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO article (
            title, slug, summary, cover_url,
            content_md, content_html, status,
            is_top, is_recommend,
            seo_title, seo_keywords, seo_description,
            author_id, author_name,
            main_category_id, main_category_name,
            tag_ids_csv, tag_names_csv,
            view_count, like_count, comment_count,
            published_at, extra, remark,
            created_at, updated_at, deleted_at
        )
        VALUES (
                   #{title}, #{slug}, #{summary}, #{coverUrl},
                   #{contentMd}, #{contentHtml}, #{status},
                   #{isTop}, #{isRecommend},
                   #{seoTitle}, #{seoKeywords}, #{seoDescription},
                   #{authorId}, #{authorName},
                   #{mainCategoryId}, #{mainCategoryName},
                   #{tagIdsCsv}, #{tagNamesCsv},
                   #{viewCount}, #{likeCount}, #{commentCount},
                   #{publishedAt}, #{extra}, #{remark},
                   #{createdAt}, #{updatedAt}, #{deletedAt}
               )
    </insert>


    <update id="update">
        UPDATE article
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="slug != null">slug = #{slug},</if>
            <if test="summary != null">summary = #{summary},</if>
            <if test="coverUrl != null">cover_url = #{coverUrl},</if>
            <if test="contentMd != null">content_md = #{contentMd},</if>
            <if test="contentHtml != null">content_html = #{contentHtml},</if>
            <if test="status != null">status = #{status},</if>
            <if test="isTop != null">is_top = #{isTop},</if>
            <if test="isRecommend != null">is_recommend = #{isRecommend},</if>
            <if test="seoTitle != null">seo_title = #{seoTitle},</if>
            <if test="seoKeywords != null">seo_keywords = #{seoKeywords},</if>
            <if test="seoDescription != null">seo_description = #{seoDescription},</if>
            <if test="authorId != null">author_id = #{authorId},</if>
            <if test="authorName != null">author_name = #{authorName},</if>
            <if test="mainCategoryId != null">main_category_id = #{mainCategoryId},</if>
            <if test="mainCategoryName != null">main_category_name = #{mainCategoryName},</if>
            <if test="tagIdsCsv != null">tag_ids_csv = #{tagIdsCsv},</if>
            <if test="tagNamesCsv != null">tag_names_csv = #{tagNamesCsv},</if>
            <if test="viewCount != null">view_count = #{viewCount},</if>
            <if test="likeCount != null">like_count = #{likeCount},</if>
            <if test="commentCount != null">comment_count = #{commentCount},</if>
            <if test="publishedAt != null">published_at = #{publishedAt},</if>
            <if test="extra != null">extra = #{extra},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="createdAt != null">created_at = #{createdAt},</if>
            <if test="updatedAt != null">updated_at = #{updatedAt},</if>
            <if test="deletedAt != null">deleted_at = #{deletedAt},</if>
        </set>
        WHERE id = #{id}
    </update>



</mapper>
